# Configuration constants for building XEmacs packages
# Copyright (C) 1997 Free Software Foundation Inc.

# This file is part of XEmacs.

# XEmacs is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by the
# Free Software Foundation; either version 2, or (at your option) any
# later version.

# XEmacs is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
# FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
# for more details.

# You should have received a copy of the GNU General Public License
# along with XEmacs; see the file COPYING.  If not, write to
# the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
# Boston, MA 02111-1307, USA.

# Requires XEmacs 21.0-beta19 or greater

# Developer configurable portion

# path to XEmacs-21.0
XEMACS = /home/xemacs/xemacs-20.0/src/xemacs

# Build Mule?  Comment for no Mule
BUILD_MULE=t

# path to BSD install
INSTALL = ginstall -c

# path to GNU tar
TAR = /usr/bin/tar

# Stuff tar should never archive
EXCLUDES = --exclude 'CVS' --exclude '*~' --exclude '*.orig' --exclude '*.rej'

VANILLA = -vanilla

# path to makeinfo
MAKEINFO = makeinfo

# path to directory to install packages in
PKGDIR = /usr/local/lib/xemacs/xemacs-packages

# path to directory for builing kits for distribution
STAGING = /tmp/staging

# path to GNU cp, use the latter if no GNU cp is available.
RCOPY = cp -a
# RCOPY = cp -pR

# Override or add to this in the package Makefile if necessary
GENERATED = auto-autoloads.elc

# SOURCE_FILES_TO_COPY = *.el*
SOURCE_FILES_TO_COPY = $(ELCS) $(ELCS:.elc=.el) $(MULE_ELCS) $(MULE_ELCS:.elc=.el) $(GENERATED) $(GENERATED:.elc=.el) _pkg.el

# Non configurable portion follows

MANIFEST = pkginfo/MANIFEST.$(PACKAGE)

.SUFFIXES:
.SUFFIXES: .info .texi .dvi .elc .el

%.info: %.texi
	$(MAKEINFO) $(MAKEINFO_FLAGS) -o $@ $<

%.elc: %.el
	$(XEMACS) -no-autoloads -batch $(PRELOADS) -l ../../package-compile.el -- $(REQUIRES) -- $<

all:: _pkg.el

dist:: srckit binkit package-info

clean::
	rm -f $(ELCS) $(PACKAGE).info* auto-autoloads.elc custom-load.elc

mostlyclean: clean

extraclean: clean

distclean: extraclean
	rm -f core *~ auto-autoloads.el custom-load.el package-info _pkg.el

auto-autoloads.el : $(ELCS:.elc=.el) _pkg.el
	$(XEMACS) $(VANILLA) -batch \
		-eval "(setq autoload-package-name \"$(PACKAGE)\")" \
		-l autoload -f batch-update-directory .
	@rm -f auto-autoloads.el~

custom-load.el : $(ELCS:.elc=.el)
	$(XEMACS) $(VANILLA) -batch -l cus-dep \
		-f Custom-make-dependencies .

package-info : package-info.in Makefile _pkg.el $(STAGING)/$(PACKAGE)-$(VERSION)-pkg.tar.gz
	$(XEMACS) $(VANILLA) -batch \
		-l package-info.el -f batch-update-package-info \
		'$(VERSION)' $(STAGING)/$(PACKAGE)-$(VERSION)-pkg.tar.gz \
		'$(REQUIRES)' \
		'$(AUTHOR_VERSION)' '$(MAINTAINER)' '$(CATEGORY)'

_pkg.el: Makefile
	@echo Creating _pkg.el
	@echo ";;;###autoload" > _pkg.el
	@echo "(package-provide '$(PACKAGE)" >> _pkg.el
	@echo "		 :version $(VERSION)" >> _pkg.el
	@echo "		 :type '$(PKG_TYPE))" >> _pkg.el

.PHONY: srckit-std
.PHONY: binkit-sourceonly binkit-sourceinfo binkit-sourcedata binkit-sourcedatainfo
.PHONY: bindist

bindist: binkit package-info

srckit-std: distclean
	if [ ! -d $(STAGING) ]; then mkdir -p $(STAGING); fi
	(cd ../..; \
	rm -f $(STAGING)/$(PACKAGE)-$(VERSION)-src.tar*; \
	$(TAR) $(EXCLUDES) -cf $(STAGING)/$(PACKAGE)-$(VERSION)-src.tar $(CATEGORY)/$(PACKAGE))
	gzip -v9 $(STAGING)/$(PACKAGE)-$(VERSION)-src.tar

binkit-sourceonly: all
	-rm -rf $(STAGING)/lisp/$(PACKAGE)
	-mkdir -p $(STAGING)/lisp/$(PACKAGE)
	-rm -f $(STAGING)/$(MANIFEST)
	-mkdir -p $(STAGING)/pkginfo
	-touch $(STAGING)/$(MANIFEST)
	$(RCOPY) ChangeLog $(SOURCE_FILES_TO_COPY) $(EXTRA_SOURCES) $(STAGING)/lisp/$(PACKAGE)
	(cd $(STAGING); \
	rm -f $(PACKAGE)-$(VERSION)-pkg.tar*; \
	ls -1 $(MANIFEST) lisp/$(PACKAGE)/* > $(MANIFEST); \
	$(TAR) $(EXCLUDES) -cf $(PACKAGE)-$(VERSION)-pkg.tar \
		$(MANIFEST) lisp/$(PACKAGE); \
	gzip -v9 $(PACKAGE)-$(VERSION)-pkg.tar)

binkit-sourceinfo: all
	-rm -rf $(STAGING)/lisp/$(PACKAGE)
	-mkdir -p $(STAGING)/lisp/$(PACKAGE)
	-mkdir -p $(STAGING)/info
	-(cd $(STAGING)/info; rm -rf $(notdir $(INFO_FILES)))
	-(cd $(STAGING)/man; rm -rf $(PACKAGE))
	-mkdir -p $(STAGING)/man/$(PACKAGE)
	-rm -f $(STAGING)/$(MANIFEST)
	-mkdir -p $(STAGING)/pkginfo
	-touch $(STAGING)/$(MANIFEST)
	$(RCOPY) ChangeLog $(SOURCE_FILES_TO_COPY) $(EXTRA_SOURCES) $(STAGING)/lisp/$(PACKAGE)
	$(RCOPY) $(INFO_FILES) $(STAGING)/info
	$(RCOPY) $(TEXI_FILES) $(STAGING)/man/$(PACKAGE)
	(cd $(STAGING); \
	rm -f $(PACKAGE)-$(VERSION)-pkg.tar*; \
	ls -1 $(MANIFEST) lisp/$(PACKAGE)/* man/$(PACKAGE)/* \
		$(patsubst %,info/%, $(notdir $(INFO_FILES))) > $(MANIFEST); \
	$(TAR) $(EXCLUDES) -cf $(PACKAGE)-$(VERSION)-pkg.tar lisp/$(PACKAGE) \
		$(patsubst %,info/%, $(notdir $(INFO_FILES))) \
		man/$(PACKAGE) $(MANIFEST); \
	gzip -v9 $(PACKAGE)-$(VERSION)-pkg.tar)

binkit-sourcedata: all
	-rm -rf $(STAGING)/lisp/$(PACKAGE)
	-mkdir -p $(STAGING)/lisp/$(PACKAGE)
	-rm -rf $(patsubst %, $(STAGING)/etc/$(DATA_DEST)/%, $(notdir $(DATA_FILES)))
	-mkdir -p $(STAGING)/etc/$(DATA_DEST)
	-rm -f $(STAGING)/$(MANIFEST)
	-mkdir -p $(STAGING)/pkginfo
	-touch $(STAGING)/$(MANIFEST)
	$(RCOPY) ChangeLog $(SOURCE_FILES_TO_COPY) $(EXTRA_SOURCES) $(STAGING)/lisp/$(PACKAGE)
	$(RCOPY) $(DATA_FILES) $(STAGING)/etc/$(DATA_DEST)
	(cd $(STAGING); \
	rm -f $(PACKAGE)-$(VERSION)-pkg.tar*; \
	ls -1 lisp/$(PACKAGE)/* \
		$(patsubst %, etc/$(DATA_DEST)/%, $(notdir $(DATA_FILES))) \
		$(MANIFEST) > $(MANIFEST); \
	$(TAR) $(EXCLUDES) -cf $(PACKAGE)-$(VERSION)-pkg.tar lisp/$(PACKAGE) \
		$(patsubst %, etc/$(DATA_DEST)/%, $(notdir $(DATA_FILES))) \
		$(MANIFEST); \
	gzip -v9 $(PACKAGE)-$(VERSION)-pkg.tar)

binkit-sourcedatainfo: all
	-rm -rf $(STAGING)/lisp/$(PACKAGE)
	-mkdir -p $(STAGING)/lisp/$(PACKAGE)
	-mkdir -p $(STAGING)/info
	-(cd $(STAGING)/info; rm -rf $(notdir $(INFO_FILES)))
	-(cd $(STAGING)/man; rm -rf $(PACKAGE))
	-mkdir -p $(STAGING)/man/$(PACKAGE)
	-rm -rf $(patsubst %, $(STAGING)/etc/$(DATA_DEST)/%, $(notdir $(DATA_FILES)))
	-mkdir -p $(STAGING)/etc/$(DATA_DEST)
	-rm -f $(STAGING)/$(MANIFEST)
	-mkdir -p $(STAGING)/pkginfo
	-touch $(STAGING)/$(MANIFEST)
	$(RCOPY) ChangeLog $(SOURCE_FILES_TO_COPY) $(EXTRA_SOURCES) $(STAGING)/lisp/$(PACKAGE)
	$(RCOPY) $(INFO_FILES) $(STAGING)/info
	$(RCOPY) $(TEXI_FILES) $(STAGING)/man/$(PACKAGE)
	$(RCOPY) $(DATA_FILES) $(STAGING)/etc/$(DATA_DEST)
	(cd $(STAGING); \
	rm -f $(PACKAGE)-$(VERSION)-pkg.tar*; \
	ls -1 lisp/$(PACKAGE)/* man/$(PACKAGE)/* \
		$(patsubst %,info/%, $(notdir $(INFO_FILES))) \
		$(patsubst %, etc/$(DATA_DEST)/%, $(notdir $(DATA_FILES))) \
		$(MANIFEST) > $(MANIFEST); \
	$(TAR) $(EXCLUDES) -cf $(PACKAGE)-$(VERSION)-pkg.tar lisp/$(PACKAGE) \
		$(patsubst %,info/%, $(notdir $(INFO_FILES))) \
		man/$(PACKAGE) \
		$(patsubst %, etc/$(DATA_DEST)/%, $(notdir $(DATA_FILES))) \
		$(MANIFEST); \
	gzip -v9 $(PACKAGE)-$(VERSION)-pkg.tar)
